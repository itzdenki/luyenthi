{% extends "base.html" %}
{% load i18n %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
<style>
    .result-wrapper { background-color: var(--bg-surface); padding: 2rem; border-radius: 0.75rem; text-align: center; border: 1px solid var(--border); }
    .answer-review-container { margin-top: 2rem; text-align: left; }
    .review-question-box { background-color: var(--bg-primary); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border); }
    .review-choice-item { padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.25rem; border-left: 4px solid transparent; }
    .correct-answer { border-left-color: var(--success); background-color: rgba(16, 185, 129, 0.1); }
    .user-incorrect { border-left-color: var(--error); background-color: rgba(220, 38, 38, 0.1); }
    .passage-box { background-color: var(--bg-surface); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem; border: 1px solid var(--border); line-height: 1.7; }
</style>
<div class="result-wrapper">
    <h2>{{ page_title }}</h2>
    <p class="details">{% trans "Bài thi" %}: {{ result.exam.title }} | {% trans "Nộp lúc" %}: {{ result.submitted_at|date:"H:i, d/m/Y" }}</p>
    <p>{% trans "Điểm số" %}:</p>
    <p class="score-display">{{ result.score|floatformat:2 }}</p>
    <a href="{% url 'exam_result_history' pk=result.exam.pk %}" class="btn" style="background-color: var(--text-secondary); color: var(--bg-primary);">&larr; {% trans "Quay lại Lịch sử" %}</a>
</div>
<div class="answer-review-container">
    <h2 style="margin-bottom: 2rem; text-align: center;">{% trans "Đáp án chi tiết" %}</h2>
    {% macro render_review(question) %}
        <h4>{% trans "Câu" %} {{ forloop.counter }}: {{ question.text|safe }}</h4>
        <div style="margin-top: 1rem;">
            {% for choice in question.choices.all %}
                {% with choice_id_str=choice.id|stringformat:"s" %}
                    <div class="review-choice-item {% if choice.is_correct %}correct-answer{% endif %} {% if choice_id_str == question.student_answer and not choice.is_correct %}user-incorrect{% endif %}">
                        <input type="radio" disabled {% if choice_id_str == question.student_answer %}checked{% endif %}>
                        <label>{{ choice.text|safe }}</label>
                    </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% endmacro %}
    {% for passage in passages %}
        <div class="passage-box">
            <h4>{{ passage.title }}</h4>
            <p>{{ passage.content|safe|linebreaks }}</p>
        </div>
        {% for question in passage.related_questions %}
            <div class="review-question-box">{{ render_review(question) }}</div>
        {% endfor %}
    {% endfor %}
    {% for question in non_passage_questions %}
        <div class="review-question-box">{{ render_review(question) }}</div>
    {% endfor %}
</div>
{% endblock %}
